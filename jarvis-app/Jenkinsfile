
// 3.01-jenkins-pipeline
pipeline {
    agent any

    stages {
        // 3.02-jenkins-app-build
        stage('ğŸ“¦ Build Quarkus app âš¡ï¸') {
            steps {
                dir('jarvis-app') {
                script {
                    jarvis.buildMaven()
                    }
                }
            }
        }
        // 3.03-jenkins-docker-build
        stage('ğŸ³ Build Docker image ğŸ³') {
            steps {
                dir('jarvis-app') {
                    script {
                        docker.withRegistry('https://95y036e0.gra7.container-registry.ovh.net/devoxx', 'harbor') {
                            def image = docker.build('95y036e0.gra7.container-registry.ovh.net/devoxx/jarvis-app', '-f src/main/docker/Dockerfile.jvm .')
                            image.push("v${env.BUILD_NUMBER}")
                        }
                    }
                }
            }
        }
        // 3.04-jenkins-github-tag
        stage('ğŸ·ï¸ Tag et Push dans GitHub ğŸ™') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'gh-token', usernameVariable: 'GIT_USERNAME', passwordVariable: 'GIT_PASSWORD')]) {
                    script {
                        jarvis.tag(userName: GIT_USERNAME, password: GIT_PASSWORD, buildNumber: BUILD_NUMBER)
                    }
                }
            }
        }
        // 3.05-jenkins-github-release
        stage('ğŸªª Release GitHub ğŸªª') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'gh-token',  usernameVariable: 'GIT_USERNAME', passwordVariable: 'GITHUB_TOKEN')]) {
                    sh 'curl -X POST \
                         https://api.github.com/repos/${GIT_USERNAME}/java-full-stack/releases \
                         -H "Authorization: Bearer ${GITHUB_TOKEN}" \
                         -H "Content-Type: application/json" \
                         -d "{\\"tag_name\\": \\"v$BUILD_NUMBER\\", \\"name\\": \\"Release $BUILD_NUMBER\\", \\"draft\\": false, \\"prerelease\\": false}"'
                }
            }
        }
    }
    // 3.06-jenkins-post-pipeline
    post {
        success {
            echo 'âœ… DÃ©ploiement rÃ©ussi ! ğŸ¤©'
        }
        failure {
            echo 'âŒ Ã‰chec du dÃ©ploiement ğŸ˜­'
        }
    }
}
